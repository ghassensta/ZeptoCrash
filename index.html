<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ZeptoCrash – Focus Curve + Records (no Lottie)</title>

<style>
  :root{ --bg1:#0b1020; --bg2:#111a33; --acc1:#00d4ff; --acc2:#00ff88; --acc3:#ffaa00; --danger:#ff4444; }
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    background:
      radial-gradient(1200px 600px at 90% -10%, #1f2a50 0%, transparent 60%),
      radial-gradient(900px 500px at 10% 110%, #142449 0%, transparent 60%),
      linear-gradient(135deg, #0f1224, #0b0f1f 70%, #090d1a);
    min-height:100vh;color:#fff;overflow-x:hidden
  }
  .container{max-width:1200px;margin:0 auto;padding:24px;min-height:100vh;display:grid;grid-template-rows:auto 1fr auto;gap:20px}
  .glass{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter: blur(10px)}
  .header{ text-align:center; padding:22px 14px; border-radius:16px; position:relative }
  .header h1{font-size:2.2rem;color:var(--acc1);text-shadow:0 0 18px rgba(0,212,255,.35);letter-spacing:.5px}
  .header p{opacity:.9;margin-top:6px}

  .main{display:grid;grid-template-columns:2fr 1fr;gap:26px}

  /* ===== FOCUS CARD ===== */
  .focus-card{position:relative;border-radius:22px;overflow:hidden}
  .focus-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.12)}
  .title{font-weight:900;color:var(--acc1)}
  .hud{display:flex;align-items:center;gap:10px}
  .badge{background:linear-gradient(135deg,rgba(0,212,255,.25),rgba(0,255,136,.25));border:1px solid rgba(255,255,255,.35);padding:6px 12px;border-radius:999px;font-weight:900;text-shadow:0 0 10px rgba(0,0,0,.6);backdrop-filter: blur(6px)}
  .chip{font-size:.8rem;opacity:.9;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.2)}
  .chip.wait{background:rgba(255,209,102,.14);border-color:rgba(255,209,102,.35)}
  .chip.play{background:rgba(0,255,136,.12);border-color:rgba(0,255,136,.35)}
  .chip.crash{background:rgba(255,68,68,.12);border-color:rgba(255,68,68,.35)}

  .stage{position:relative;height:420px}
  .chart{position:absolute; inset:0}
  .chart svg{width:100%; height:100%; display:block}
  .chart .bg-rect{opacity:.9}

  /* starfield with '*' */
  .starfield{ position:absolute; inset:0; z-index:0; overflow:hidden; pointer-events:none; }
  .star{ position:absolute; bottom:-20px; color:#fff; opacity:0; font-weight:800; text-shadow:0 0 8px rgba(255,255,255,.8);
         animation: starRise var(--dur,3500ms) linear forwards; font-size: var(--size,14px); left: var(--x,50%); }
  .star.trail{ animation:none; }
  @keyframes starRise{ 0%{ transform:translateY(0) scale(.8); opacity:0 } 10%{ opacity:.95 } 100%{ transform:translateY(-120vh) scale(1); opacity:0 } }

  /* Focus halo + dot that follow the path */
  .focus-light{ position:absolute; width:260px; height:260px; border-radius:50%; pointer-events:none; z-index:1; opacity:0;
    background: radial-gradient(closest-side, rgba(0,212,255,.28), rgba(0,212,255,.12) 60%, rgba(0,0,0,0) 70%);
    filter: blur(10px); transform:translate(-1000px,-1000px) scale(1); transition: opacity .2s ease }
  .focus-dot{ position:absolute; width:16px; height:16px; border-radius:50%; background:#fff; border:2px solid rgba(255,255,255,.65);
    box-shadow:0 0 16px rgba(0,212,255,.9), 0 0 36px rgba(0,255,136,.35); transform:translate(-9999px,-9999px); z-index:2; }

  .crash-animation{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3rem;font-weight:900;color:var(--danger);text-shadow:0 0 30px rgba(255,68,68,.8);opacity:0;z-index:3;pointer-events:none}
  .crash-animation.show{animation:crashPulse 1.8s ease-out}
  @keyframes crashPulse{0%{opacity:0;transform:translate(-50%,-50%) scale(.6)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.15)}100%{opacity:0;transform:translate(-50%,-50%) scale(1)}}

  /* ===== LAST STAR LIST ===== */
  .last-list{display:flex;align-items:center;gap:8px;padding:8px 12px;border-top:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));overflow-x:auto}
  .star-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);font-weight:800;user-select:none;cursor:pointer;white-space:nowrap}
  .star-chip .sym{font-size:1rem;filter:drop-shadow(0 2px 6px rgba(255,255,255,.4))}
  .star-chip.win{background:rgba(0,255,136,.08);border-color:rgba(0,255,136,.35)}
  .star-chip.loss{background:rgba(255,68,68,.08);border-color:rgba(255,68,68,.35)}
  .star-chip.neut{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.22)}
  .star-chip:hover{transform:translateY(-1px)}

  /* ===== LEFT: controls ===== */
  .left{display:grid;gap:18px}
  .panel{border-radius:16px;padding:16px}
  .panel h3{margin-bottom:10px;color:var(--acc1)}
  .row{display:flex;align-items:center;gap:10px}
  .bet-input{flex:1;padding:12px;border:1px solid rgba(255,255,255,.28);border-radius:10px;background:rgba(255,255,255,.08);color:#fff}
  .bet-input:focus{outline:none;border-color:var(--acc1);box-shadow:0 0 0 3px rgba(0,212,255,.20)}
  .quick-bets{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .quick-bet{padding:9px;border-radius:9px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:#fff;cursor:pointer;font-size:.92rem;transition:.25s}
  .quick-bet:hover{transform:translateY(-1px);background:rgba(0,212,255,.18);border-color:var(--acc1)}
  .game-button{width:100%;padding:14px 16px;font-weight:800;border:none;border-radius:12px;cursor:pointer;transition:transform .2s, box-shadow .2s;text-transform:uppercase}
  .bet-button{background:linear-gradient(45deg,var(--acc2),var(--acc1));color:#061018}
  .cashout-button{background:linear-gradient(45deg,var(--acc3),#ff6a00);color:#1a0f06}
  .game-button:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 12px 24px rgba(0,0,0,.25)}
  .game-button:disabled{opacity:.55;cursor:not-allowed}
  button, .quick-bet { touch-action: manipulation; }

  .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:14px}
  .stat-item{text-align:center;padding:10px;background:rgba(255,255,255,.06);border-radius:10px}
  .stat-value{font-size:1.35rem;font-weight:800;color:var(--acc1)} .stat-label{font-size:.9rem;opacity:.8}

  /* RIGHT SIDEBAR */
  .sidebar{display:flex;flex-direction:column;gap:20px}
  .balance-card,.history-card,.records-card{border-radius:16px;padding:18px}
  .balance-card h2{color:var(--acc1);margin-bottom:8px;text-align:center}
  .balance-amount{font-size:2rem;font-weight:900;text-align:center;color:var(--acc2);text-shadow:0 0 18px rgba(0,255,136,.4)}
  .balance-delta{height:22px;text-align:center;font-weight:900;margin-top:6px}
  .balance-delta.plus{color:#00ff88}
  .balance-delta.minus{color:#ff6a6a}

  .history-card h3,.records-card h3{color:var(--acc1);margin-bottom:10px;text-align:center}
  .history-list{max-height:340px;overflow-y:auto}
  .history-item{display:flex;justify-content:space-between;align-items:center;padding:10px;margin-bottom:8px;background:rgba(255,255,255,.06);border-radius:10px;border-left:4px solid}
  .history-item.win{border-left-color:var(--acc2)} .history-item.loss{border-left-color:var(--danger)} .history-item.spectate{border-left-color:rgba(255,255,255,.28)}
  .history-multiplier{font-weight:800} .history-multiplier.win{color:var(--acc2)} .history-multiplier.loss{color:var(--danger)} .history-multiplier.spectate{color:#eaeaea}

  /* Records card list */
  .records-list{display:grid;grid-template-columns:1fr;gap:8px;max-height:240px;overflow-y:auto}
  .rec{display:flex;justify-content:space-between;gap:10px;padding:10px;background:rgba(255,255,255,.06);border-radius:10px;border:1px solid rgba(255,255,255,.1)}
  .rec .tag{font-weight:900}
  .rec.win .tag{color:var(--acc2)}
  .rec.loss .tag{color:var(--danger)}

  /* Toast */
  .toast{ position:absolute; left:50%; bottom:70px; transform:translateX(-50%) translateY(20px); opacity:0; padding:10px 14px; border-radius:10px; background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.2); backdrop-filter:blur(8px); transition:opacity .2s, transform .2s; font-weight:700 }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }

  /* ===== Modals (Win/Lose) ===== */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:.25s}
  .modal-overlay.show{opacity:1;visibility:visible}
  .modal{background:linear-gradient(145deg, rgba(255,255,255,.16), rgba(255,255,255,.07));border-radius:22px;padding:28px;text-align:center;border:2px solid rgba(255,255,255,.28);max-width:420px;width:92%;transform:scale(.8) translateY(20px);transition:.3s cubic-bezier(.34,1.56,.64,1)}
  .modal-overlay.show .modal{transform:scale(1) translateY(0)}
  .modal.win{box-shadow:0 20px 44px rgba(0,255,136,.22)}
  .modal.lose{box-shadow:0 20px 44px rgba(255,68,68,.22)}
  .modal h2{font-size:2rem;margin-bottom:6px}
  .modal h2.win{color:var(--acc2)}
  .modal h2.lose{color:var(--danger)}
  .modal .amount{font-size:1.8rem;font-weight:900;margin:12px 0}
  .modal .amount.win{color:var(--acc2)}
  .modal .amount.lose{color:var(--danger)}
  .modal .details{background:rgba(255,255,255,.08);border-radius:14px;padding:12px;margin-bottom:14px}
  .details .row{display:flex;justify-content:space-between;margin:6px 0}
  .details .row:last-child{font-weight:800;color:var(--acc1);border-top:1px solid rgba(255,255,255,.2);padding-top:8px;margin-top:6px}
  .modal .close{background:linear-gradient(45deg,#666,#888);color:#fff;border:none;border-radius:10px;padding:10px 18px;font-weight:800;cursor:pointer}

  .footer{text-align:center;padding:18px;border-radius:16px}

  /* ===== Mobile polish ===== */
  @media (max-width: 1020px){ .main{grid-template-columns:1fr} }
  @media (max-width: 780px){
    .header h1{font-size:1.8rem}
    .stage{height:360px}
    .badge{padding:5px 10px}
  }
  @media (max-width: 520px){
    .header h1{font-size:1.6rem}
    .stage{height:300px}
    .badge{font-size:.9rem}
    .chip{font-size:.75rem}
    .stats{grid-template-columns:repeat(2,1fr)}
    .last-list{gap:6px}
    .panel{padding:14px}
  }
  @media (prefers-reduced-motion: reduce){
    .star, .star.trail{animation-duration:2000ms}
  }
</style>
</head>
<body>
  <div class="container">
    <header class="header glass">
      <h1>🎮 ZeptoCrash</h1>
    </header>

    <main class="main">
      <div class="left">
        <!-- FOCUS CARD -->
        <section class="focus-card glass" id="focusCard">
          <div class="focus-header">
            <div class="title">🎯 Focus Curve</div>
            <div class="hud">
              <div class="badge" id="hudMult">1.00x</div>
              <div class="chip wait" id="statusChip">En attente</div>
            </div>
          </div>
          <div class="stage" id="stage">
            <div class="chart">
              <svg id="focusSvg" viewBox="0 0 1000 700" preserveAspectRatio="none">
                <defs>
                  <pattern id="grid" width="80" height="80" patternUnits="userSpaceOnUse">
                    <path d="M 80 0 L 0 0 0 80" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="1"/>
                  </pattern>
                  <linearGradient id="areaGrad" x1="0" y1="1" x2="0" y2="0">
                    <stop offset="0%" stop-color="rgba(255,132,0,.12)"/>
                    <stop offset="100%" stop-color="rgba(255,132,0,.35)"/>
                  </linearGradient>
                </defs>
                <rect class="bg-rect" width="100%" height="100%" fill="url(#grid)"/>
                <!-- courbe exponentielle approx -->
                <path id="curvePath" d="M60 630 C 240 600, 400 520, 560 380 S 880 120, 960 50" fill="none" stroke="#ff7a00" stroke-width="6" stroke-linecap="round"/>
                <path d="M60 680 L60 630 C 240 600, 400 520, 560 380 S 880 120, 960 50 L 960 680 Z" fill="url(#areaGrad)" opacity=".35"/>
              </svg>
            </div>
            <div class="starfield" id="starfield"></div>
            <div class="focus-light" id="focusLight"></div>
            <div class="focus-dot" id="focusDot" aria-label="focus"></div>
            <div class="crash-animation" id="crashAnimation">💥 CRASH!</div>
            <div class="toast" id="roundToast"></div>
          </div>
          <!-- last star list -->
          <div class="last-list" id="lastStarList"></div>
        </section>

        <!-- Controls -->
        <section class="panel glass">
          <h3>💰 Mise</h3>
          <div class="row">
            <input type="number" id="betAmount" class="bet-input" value="50" min="10" max="500" />
            <span>AED</span>
          </div>
          <div class="quick-bets" style="margin-top:8px">
            <button class="quick-bet" onclick="setBetAmount(10)">10</button>
            <button class="quick-bet" onclick="setBetAmount(50)">50</button>
            <button class="quick-bet" onclick="setBetAmount(100)">100</button>
          </div>
          <button id="betButton" class="game-button bet-button" style="margin-top:10px">Placer la mise</button>
        </section>

        <section class="panel glass">
          <h3>⚙️ Action & Focus</h3>
          <button id="cashoutButton" class="game-button cashout-button" disabled>Encaisser</button>
          <div class="row" style="margin-top:10px">
            <input type="checkbox" id="autoCashout" class="checkbox" />
            <label for="autoCashout">Auto-encaissement à</label>
            <input type="number" id="autoCashoutValue" class="bet-input" value="2.00" min="1.01" max="10" step="0.01" disabled />
          </div>
          <div class="row" style="margin-top:10px">
            <input type="checkbox" id="focusMode" class="checkbox" checked />
            <label for="focusMode">🟢 Mode Focus (halo)</label>
            <input type="checkbox" id="focusBeep" class="checkbox" />
            <label for="focusBeep">🔔 Bips focus</label>
          </div>
        </section>

        <section class="panel glass">
          <h3>📈 Statistiques</h3>
          <div class="stats">
            <div class="stat-item"><div class="stat-value" id="totalGames">0</div><div class="stat-label">Manches</div></div>
            <div class="stat-item"><div class="stat-value" id="totalWins">0</div><div class="stat-label">Victoires</div></div>
            <div class="stat-item"><div class="stat-value" id="winRate">0%</div><div class="stat-label">Taux de réussite</div></div>
            <div class="stat-item"><div class="stat-value" id="biggestWin">0</div><div class="stat-label">Plus gros gain</div></div>
          </div>
        </section>
      </div>

      <aside class="sidebar">
        <div class="balance-card glass">
          <h2>💳 Solde</h2>
          <div class="balance-amount" id="balance">1000 AED</div>
          <div class="balance-delta" id="balanceDelta"></div>
        </div>
        <div class="records-card glass">
          <h3>📜 Records – Derniers rounds</h3>
          <div class="records-list" id="recordsList">
            <div style="text-align:center; opacity:.6; padding:10px;">Aucun round</div>
          </div>
        </div>
        <div class="history-card glass">
          <h3>📊 Historique de tous les rounds</h3>
          <div class="history-list" id="historyList">
            <div style="text-align:center; opacity:.6; padding:20px;">Aucune manche jouée</div>
          </div>
        </div>
      </aside>
    </main>

    <footer class="footer glass">
      <p>🎯 Vue focus <strong>neutre</strong> (aucune donnée de proba utilisée) | ✨ ✱ Derniers rounds | 🟢 Halo | 🔔 Bips (optionnel)</p>
      <p style="margin-top:10px;opacity:.7">Prototype – Argent fictif uniquement</p>
    </footer>
  </div>

  <!-- WIN MODAL -->
  <div class="modal-overlay" id="winModal">
    <div class="modal win">
      <div style="font-size:2.4rem">🎉</div>
      <h2 class="win">Félicitations !</h2>
      <p>Encaissement réussi.</p>
      <div class="amount win" id="winAmount">+250 AED</div>
      <div class="details">
        <div class="row"><span>Mise</span><span id="winBet">—</span></div>
        <div class="row"><span>Multiplicateur</span><span id="winMult">—</span></div>
        <div class="row"><span>Gain total</span><span id="winTotal">—</span></div>
      </div>
      <button class="close" onclick="closeModal('winModal')">Continuer</button>
    </div>
  </div>

  <!-- LOSE MODAL -->
  <div class="modal-overlay" id="loseModal">
    <div class="modal lose">
      <div style="font-size:2.4rem">💥</div>
      <h2 class="lose">Dommage…</h2>
      <p>Le crash est arrivé trop tôt.</p>
      <div class="amount lose" id="loseAmount">-100 AED</div>
      <div class="details">
        <div class="row"><span>Mise</span><span id="loseBet">—</span></div>
        <div class="row"><span>Crash à</span><span id="loseAt">—</span></div>
        <div class="row"><span>Perte</span><span id="loseTotal">—</span></div>
      </div>
      <button class="close" onclick="closeModal('loseModal')">Réessayer</button>
    </div>
  </div>

<script>
// ===== helpers =====
const clamp=(v,min=0,max=1)=> Math.max(min, Math.min(max, v));
const lerp=(a,b,t)=> a+(b-a)*t;
const easeOutCubic=(t)=>{t=clamp(t,0,1); return 1-Math.pow(1-t,3)};

class ZeptoCrashGame {
  constructor(){
    this.balance=1000; this.currentBet=0; this.currentMultiplier=1; this.crashPoint=0;
    this.gameState='waiting'; this.startTime=0; this.hasPlayerBet=false; this.hasCashedOut=false;
    this.cashoutAt=null; this.winAmount=0; this.roundId=0;
    this.VISUAL_MAX_X=50; // ⛔ Neutre: la progression visuelle n'utilise pas crashPoint

    this.stats={ totalGames:0,totalWins:0,totalLosses:0,biggestWin:0,totalWagered:0,totalWon:0 };
    this.history=this.loadRounds(); // charge depuis localStorage

    // DOM
    this.el={
      svg: document.getElementById('focusSvg'),
      stage: document.getElementById('stage'),
      path: document.getElementById('curvePath'),
      focusDot: document.getElementById('focusDot'),
      hudMult: document.getElementById('hudMult'), statusChip: document.getElementById('statusChip'),
      balance: document.getElementById('balance'), balanceDelta: document.getElementById('balanceDelta'),
      betAmount: document.getElementById('betAmount'), betButton: document.getElementById('betButton'),
      cashoutButton: document.getElementById('cashoutButton'), autoCashout: document.getElementById('autoCashout'), autoCashoutValue: document.getElementById('autoCashoutValue'),
      historyList: document.getElementById('historyList'), crashAnimation: document.getElementById('crashAnimation'),
      totalGames: document.getElementById('totalGames'), totalWins: document.getElementById('totalWins'), winRate: document.getElementById('winRate'), biggestWin: document.getElementById('biggestWin'),
      starfield: document.getElementById('starfield'), focusLight: document.getElementById('focusLight'), focusMode: document.getElementById('focusMode'), focusBeep: document.getElementById('focusBeep'),
      lastStarList: document.getElementById('lastStarList'), roundToast: document.getElementById('roundToast'),
      recordsList: document.getElementById('recordsList')
    };

    // Events
    this.el.betButton.addEventListener('click', ()=> this.placeBet());
    this.el.cashoutButton.addEventListener('click', ()=> this.cashOut());
    this.el.autoCashout.addEventListener('change', ()=> this.toggleAutoCashout());
    this.el.betAmount.addEventListener('input', ()=> this.validateBetAmount());
    this.el.lastStarList.addEventListener('click', (e)=>{
      const chip=e.target.closest('[data-idx]'); if(!chip) return; const idx=parseInt(chip.dataset.idx);
      const it=this.history[idx]; if(!it) return; this.showToast(`${it.type==='win'?'✅ Gain':it.type==='loss'?'❌ Perte':'👀 Spectateur'} · ${it.crashAt.toFixed(2)}x${it.type==='win'?` · +${it.winAmount} AED`:''}`);
    });
    window.addEventListener('resize', ()=> this.onResize());

    // Close modals by outside click / ESC
    document.addEventListener('click',(e)=>{ if(e.target.classList && e.target.classList.contains('modal-overlay')) e.target.classList.remove('show'); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.modal-overlay.show').forEach(m=>m.classList.remove('show')); }});

    // Starfield
    this.starTimer=null; this.lastTrailTime=0; this.pos=null;

    // Focus beep (WebAudio)
    this.audioCtx=null; this.osc=null; this.gain=null;

    // Path length
    this.pathLen = this.el.path.getTotalLength();

    // ViewBox (for robust mapping)
    const vb = this.el.svg && this.el.svg.viewBox ? this.el.svg.viewBox.baseVal : {x:0,y:0,width:1000,height:700};
    this.vbW = vb && vb.width ? vb.width : 1000; this.vbH = vb && vb.height ? vb.height : 700;

    // Animation loop state (rAF)
    this.loopHandle=0; this.lastFrame=0; this.elapsed=0; this.sProgress=0; this.motionAlpha=0.18;

    // initial render from storage
    this.renderLastStarList();
    this.renderRecords();
    this.updateStatsFromHistory();
    this.renderHistoryList();

    this.startGameLoop();
    this.startAmbientStars();
  }

  /* ===== storage ===== */
  loadRounds(){ try{ return JSON.parse(localStorage.getItem('zc_rounds')||'[]'); }catch(e){ return []; } }
  saveRounds(){ try{ localStorage.setItem('zc_rounds', JSON.stringify(this.history.slice(0,100))); }catch(e){} }

  /* ===== coords mapping from SVG space -> stage CSS pixels ===== */
  svgPointToStage(pt){
    const stageRect=this.el.stage.getBoundingClientRect();
    const svgRect=this.el.svg.getBoundingClientRect();
    const x = (pt.x/this.vbW) * svgRect.width + (svgRect.left - stageRect.left);
    const y = (pt.y/this.vbH) * svgRect.height + (svgRect.top - stageRect.top);
    return {x,y};
  }

  /* ===== STARFIELD ===== */
  spawnStar(){ if(!this.el.starfield) return; const s=document.createElement('span'); s.className='star'; s.textContent='*'; const x=Math.random()*100; const size=10+Math.random()*14; const dur=2500+Math.random()*3000; s.style.setProperty('--x',x+'%'); s.style.setProperty('--size',size+'px'); s.style.setProperty('--dur',dur+'ms'); this.el.starfield.appendChild(s); s.addEventListener('animationend',()=>s.remove()); }
  startAmbientStars(){ this.stopAmbientStars(); this.starTimer=setInterval(()=>this.spawnStar(),360); }
  stopAmbientStars(){ if(this.starTimer){ clearInterval(this.starTimer); this.starTimer=null; } }
  starBurst(n=24){ for(let i=0;i<n;i++){ setTimeout(()=> this.spawnStar(), i*18); } }

  spawnTrailAt(x,y,angleDeg){ if(!this.el.starfield) return; const el=document.createElement('span'); el.className='star trail'; el.textContent='*'; el.style.left=x+'px'; el.style.top=y+'px'; el.style.bottom='auto';
    const rad=angleDeg*Math.PI/180; const len=30+Math.random()*60; const jitter=(v)=> (Math.random()-0.5)*v; const dx=-(Math.cos(rad)*len)+jitter(12); const dy=-(Math.sin(rad)*len)+jitter(12);
    el.style.opacity='0.9'; el.style.position='absolute'; this.el.starfield.appendChild(el);
    el.animate([{opacity:1, transform:'translate(0,0) scale(1)'},{opacity:0, transform:`translate(${dx}px, ${dy}px) scale(.6)`}], {duration:650+Math.random()*520, easing:'ease-out'});
    setTimeout(()=>el.remove(), 1250);
  }
  maybeTrail(){ const now=performance.now(); if(!this.pos) return; if(!this.lastTrailTime || now-this.lastTrailTime>60){ this.spawnTrailAt(this.pos.x, this.pos.y, this.pos.angle); this.lastTrailTime=now; } }

  /* ===== UI ===== */
  setStatus(mode){ const chip=this.el.statusChip; chip.className='chip '+(mode==='waiting'?'wait':mode==='playing'?'play':'crash'); chip.textContent= mode==='waiting'?'En attente': mode==='playing'?'En cours':'CRASH'; }
  updateDisplay(){ this.el.hudMult.textContent = `${this.currentMultiplier.toFixed(2)}x`; this.el.balance.textContent=`${this.balance} AED`; }
  showBalanceDelta(text,type){ const d=this.el.balanceDelta; if(!d) return; d.textContent=text; d.className='balance-delta '+(type||''); d.animate([{opacity:0, transform:'translateY(6px)'},{opacity:1, transform:'translateY(0)'},{opacity:0.9}],{duration:250}); setTimeout(()=>{ d.textContent=''; d.className='balance-delta'; },2200); }

  getVisualProgressForMultiplier(mult){
    // Ne fuit rien: basé UNIQUEMENT sur le multiplicateur courant et une CAP visuelle fixe
    const p = Math.log(Math.max(1, mult)) / Math.log(this.VISUAL_MAX_X);
    return easeOutCubic(clamp(p));
  }

  positionFocusByProgress(p){
    p=clamp(p,0,1);
    const len=p*this.pathLen;
    const pt=this.el.path.getPointAtLength(len);
    const next=this.el.path.getPointAtLength(Math.min(len+2,this.pathLen));
    const angle=Math.atan2(next.y-pt.y, next.x-pt.x)*180/Math.PI;
    const s=1+Math.min(1,p*1.2);

    const px=this.svgPointToStage(pt);
    this.el.focusDot.style.transform=`translate(${px.x-8}px, ${px.y-8}px)`;
    if(this.el.focusLight){ this.el.focusLight.style.transform=`translate(${px.x-130}px, ${px.y-130}px) scale(${s})`; this.el.focusLight.style.opacity = this.el.focusMode.checked? 1 : 0; }
    this.pos={x:px.x, y:px.y, angle};
  }

  /* ===== Focus Beep (WebAudio) ===== */
  startFocusBeep(){ if(!this.el.focusBeep.checked) return; if(!this.audioCtx){ const C=window.AudioContext||window.webkitAudioContext; if(!C) return; this.audioCtx=new C(); }
    if(this.osc) return; try{ this.osc=this.audioCtx.createOscillator(); this.gain=this.audioCtx.createGain(); this.osc.type='sine'; this.osc.frequency.value=220; this.gain.gain.value=0.03; this.osc.connect(this.gain); this.gain.connect(this.audioCtx.destination); this.audioCtx.resume && this.audioCtx.resume(); this.osc.start(); }catch(e){ this.osc=null; }
  }
  stopFocusBeep(){ try{ if(this.osc){ this.osc.stop(); this.osc.disconnect(); this.osc=null; } if(this.gain){ this.gain.disconnect(); this.gain=null; } }catch(e){} }

  /* ===== GAME CORE ===== */
  generateCrashPoint(){ const r=Math.random(); if(r<0.5) return 1.01+Math.random()*0.49; else if(r<0.8) return 1.50+Math.random()*1.50; else if(r<0.95) return 3.00+Math.random()*7.00; else return 10.00+Math.random()*90.00; }

  startGameLoop(){ this.newRound(); }

  newRound(){
    this.cancelLoop();
    this.roundId += 1; this.cashoutAt=null; this.winAmount=0;
    this.currentMultiplier=1; this.crashPoint=this.generateCrashPoint(); this.gameState='waiting'; this.hasPlayerBet=false; this.hasCashedOut=false; this.startTime=0;
    this.updateDisplay(); this.enableBetting();
    this.sProgress=0; this.positionFocusByProgress(0);
    this.setStatus('waiting'); this.stopFocusBeep();
    let countdown=3;
    const t=setInterval(()=>{ countdown--; if(countdown>0){ this.starBurst(6);} else { clearInterval(t); this.startRound(); } },1000);
  }

  startRound(){
    this.gameState='playing'; this.startTime=performance.now(); this.setStatus('playing'); this.el.betButton.disabled = true;
    this.starBurst(16); this.startFocusBeep();
    if (this.hasPlayerBet) { this.el.cashoutButton.disabled = false; } else { this.el.cashoutButton.disabled = true; }
    this.elapsed=0; this.lastFrame=performance.now();
    this.loopHandle=requestAnimationFrame(this.frame.bind(this));
  }

  frame(now){
    const dt=now - this.lastFrame; this.lastFrame=now; this.elapsed += dt;
    // Multiplier growth (visuel + core)
    this.currentMultiplier = 1 + (this.elapsed/1000)*0.1 + Math.pow(this.elapsed/10000,2);

    // Visuel NEUTRE (indépendant de crashPoint)
    const pTarget = this.getVisualProgressForMultiplier(this.currentMultiplier);
    this.sProgress = lerp(this.sProgress, pTarget, this.motionAlpha);

    this.positionFocusByProgress(this.sProgress);
    this.maybeTrail();
    if(this.osc && this.audioCtx){ const f=180 + 220*Math.pow(this.sProgress,1.8); try{ this.osc.frequency.setValueAtTime(f, this.audioCtx.currentTime); }catch(e){} }
    this.updateDisplay();

    // seuils focus
    if(this.sProgress>0.6 && this.sProgress<0.62) this.showToast('🔆 Focus');
    if(this.sProgress>0.85 && this.sProgress<0.87) this.showToast('🔆🔆 Grand focus');

    if(this.hasPlayerBet && !this.hasCashedOut && this.el.autoCashout.checked && this.currentMultiplier>=parseFloat(this.el.autoCashoutValue.value)){ this.cashOut(); }
    if(this.currentMultiplier>=this.crashPoint){ this.crash(); return; }
    this.loopHandle=requestAnimationFrame(this.frame.bind(this));
  }

  cancelLoop(){ if(this.loopHandle){ cancelAnimationFrame(this.loopHandle); this.loopHandle=0; } }

  placeBet(){ const a=parseInt(this.el.betAmount.value); if(a>this.balance) return alert('Solde insuffisant !'); if(a<10) return alert('Mise minimum: 10 AED'); this.currentBet=a; this.balance-=a; this.showBalanceDelta(`−${a} AED`,'minus'); this.hasPlayerBet=true; this.stats.totalWagered+=a; this.updateDisplay(); this.el.betButton.disabled=true; this.el.betButton.textContent=`Mise placée: ${a} AED`; this.sProgress=0; this.positionFocusByProgress(0); this.starBurst(12); }

  cashOut(){ if(!this.hasPlayerBet||this.hasCashedOut) return; this.hasCashedOut=true; this.cashoutAt=this.currentMultiplier; const win=Math.floor(this.currentBet*this.currentMultiplier); this.winAmount=win; this.balance+=win; this.showBalanceDelta(`+${win} AED`,'plus'); this.stats.totalWins++; this.stats.totalWon+=win; const profit=win-this.currentBet; if(profit>this.stats.biggestWin) this.stats.biggestWin=profit; this.updateDisplay(); this.el.cashoutButton.disabled=true; this.showWinModal(this.currentBet, this.cashoutAt, win); }

  crash(){
    this.cancelLoop();
    this.gameState='crashed'; this.setStatus('crash');
    this.el.crashAnimation.textContent=`💥 CRASH à ${this.currentMultiplier.toFixed(2)}x!`;
    this.el.crashAnimation.className='crash-animation show';
    setTimeout(()=>{ this.el.crashAnimation.className='crash-animation'; }, 1800);

    // Compose round summary (toujours enregistré, bet ou non)
    const summary={
      id:this.roundId,
      timestamp: new Date().toISOString(),
      crashAt: this.currentMultiplier,
      type: this.hasPlayerBet ? (this.hasCashedOut? 'win':'loss') : 'spectate',
      betPlaced: this.hasPlayerBet,
      betAmount: this.hasPlayerBet? this.currentBet: 0,
      cashedOut: this.hasCashedOut,
      cashoutAt: this.hasCashedOut? this.cashoutAt: null,
      winAmount: this.hasCashedOut? this.winAmount: 0
    };
    this.pushHistory(summary);

    if(this.hasPlayerBet&&!this.hasCashedOut){ this.stats.totalLosses++; this.showBalanceDelta(`−${this.currentBet} AED`,'minus'); this.showLoseModal(this.currentBet, this.currentMultiplier); }
    this.stats.totalGames++;
    this.updateStats(); this.stopFocusBeep();

    setTimeout(()=> this.newRound(), 4200);
  }

  /* ===== Modals ===== */
  showWinModal(bet,mult,win){
    document.getElementById('winBet').textContent = `${bet} AED`;
    document.getElementById('winMult').textContent = `${mult.toFixed(2)}x`;
    document.getElementById('winAmount').textContent = `+${win} AED`;
    document.getElementById('winTotal').textContent = `${win} AED`;
    document.getElementById('winModal').classList.add('show');
  }
  showLoseModal(bet,crashAt){
    document.getElementById('loseBet').textContent = `${bet} AED`;
    document.getElementById('loseAt').textContent = `${crashAt.toFixed(2)}x`;
    document.getElementById('loseAmount').textContent = `-${bet} AED`;
    document.getElementById('loseTotal').textContent = `${bet} AED`;
    document.getElementById('loseModal').classList.add('show');
  }

  pushHistory(item){
    this.history.unshift(item); if(this.history.length>100) this.history=this.history.slice(0,100);
    this.saveRounds();
    this.renderHistoryList();
    this.renderLastStarList();
    this.renderRecords();
  }

  renderHistoryList(){
    if(this.history.length===0){ this.el.historyList.innerHTML = `<div style="text-align:center;opacity:.6;padding:20px">Aucune manche jouée</div>`; return; }
    const fmt=(iso)=> new Intl.DateTimeFormat('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date(iso));
    this.el.historyList.innerHTML = this.history.map(i=>{
      const cls = i.type==='win'?'win': i.type==='loss'?'loss':'spectate';
      const tag = i.type==='win'? 'Gain' : i.type==='loss'? 'Perte' : 'Spectateur';
      const right = i.type==='win' ? `+${i.winAmount} AED` : i.type==='loss' && i.betAmount ? `-${i.betAmount} AED` : '-';
      return `<div class="history-item ${cls}">
        <div>
          <div class="history-multiplier ${cls}">${i.crashAt.toFixed(2)}x</div>
          <div style="font-size:.8rem;opacity:.8">${fmt(i.timestamp)}</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:800;${i.type==='win'? 'color:#00ff88': i.type==='loss'?'color:#ff4444':'opacity:.9'}">${right}</div>
          <div style="font-size:.8rem;opacity:.8">${tag}${i.betAmount? ` · ${i.betAmount} AED`:''}${i.cashoutAt? ` · out ${i.cashoutAt.toFixed(2)}x`:''}</div>
        </div>
      </div>`;
    }).join('');
  }

  renderLastStarList(){
    if(!this.el.lastStarList) return; const max=16; const items=this.history.slice(0,max);
    if(items.length===0){ this.el.lastStarList.innerHTML='<span style="opacity:.6">Aucun round</span>'; return; }
    this.el.lastStarList.innerHTML = items.map((it,idx)=>{
      const cls= it.type==='win'? 'win' : it.type==='loss'? 'loss' : 'neut';
      const mult=it.crashAt.toFixed(2)+'x';
      return `<div class="star-chip ${cls}" data-idx="${idx}"><span class="sym">✱</span><span>${mult}</span></div>`;
    }).join('');
  }

  renderRecords(){
    const list=this.el.recordsList; if(!list) return;
    if(this.history.length===0){ list.innerHTML='<div style="text-align:center; opacity:.6; padding:10px;">Aucun round</div>'; return; }
    const last10=this.history.slice(0,10);
    const best= last10.reduce((a,b)=> (a && a.crashAt>b.crashAt)?a:b);
    const worst= last10.reduce((a,b)=> (a && a.crashAt<b.crashAt)?a:b);
    const wins = last10.filter(i=>i.type==='win');
    const biggestWin = wins.length? wins.reduce((a,b)=> (a.winAmount>b.winAmount?a:b)) : {winAmount:0,timestamp:null,type:'win'};

    const rows = [
      {label:'Meilleur x', val: best? best.crashAt.toFixed(2)+'x' : '-', ts: best?.timestamp, won: best?.type==='win'},
      {label:'Pire x', val: worst? worst.crashAt.toFixed(2)+'x' : '-', ts: worst?.timestamp, won: worst?.type==='win'},
      {label:'Plus gros gain', val: biggestWin && biggestWin.winAmount? (biggestWin.winAmount+' AED') : '-', ts: biggestWin?.timestamp, won: true}
    ];

    const items = last10.map(i=>({label: i.type==='win'?'Win': i.type==='loss'?'Loss':'Spect', val: i.crashAt.toFixed(2)+'x', ts:i.timestamp, won:i.type==='win'}));
    const fmt=(d)=> d? new Intl.DateTimeFormat('fr-FR', {hour:'2-digit', minute:'2-digit', second:'2-digit'}).format(new Date(d)):'';

    list.innerHTML = [
      ...rows.map(r=>`<div class="rec ${r.won?'win':'loss'}"><div class="tag">${r.label}</div><div>${r.val}</div><div style="opacity:.8">${fmt(r.ts)}</div></div>`),
      '<div style="height:6px"></div>',
      ...items.map(r=>`<div class="rec ${r.won?'win':'loss'}"><div class="tag">${r.label==='Spect'?'✱ Spect':'✱ '+r.label}</div><div>${r.val}</div><div style="opacity:.8">${fmt(r.ts)}</div></div>`)
    ].join('');
  }

  updateStats(){ const totalWins=this.history.filter(h=>h.type==='win').length; const totalLoss=this.history.filter(h=>h.type==='loss').length; const total=totalWins+totalLoss; const rate= total>0? Math.round((totalWins/total)*100):0; this.el.totalGames.textContent=totalWins+totalLoss; this.el.totalWins.textContent=totalWins; this.el.winRate.textContent=`${rate}%`; this.el.biggestWin.textContent=`${Math.max(0,...this.history.map(h=>h.winAmount||0))} AED`; }
  updateStatsFromHistory(){ this.updateStats(); }

  enableBetting(){ this.el.betButton.disabled=false; this.el.betButton.textContent='Placer la mise'; this.el.cashoutButton.disabled=true; }
  validateBetAmount(){ const a=parseInt(this.el.betAmount.value); if(a>this.balance) this.el.betAmount.value=this.balance; if(a<10) this.el.betAmount.value=10; }
  toggleAutoCashout(){ this.el.autoCashoutValue.disabled=!this.el.autoCashout.checked; }

  showToast(txt){ const el=this.el.roundToast; if(!el) return; el.textContent=txt; el.classList.add('show'); clearTimeout(this._toastT); this._toastT=setTimeout(()=> el.classList.remove('show'), 2200); }

  onResize(){ // keep dot/halo aligned after layout change
    this.pathLen = this.el.path.getTotalLength();
    const vb = this.el.svg && this.el.svg.viewBox ? this.el.svg.viewBox.baseVal : {x:0,y:0,width:1000,height:700};
    this.vbW = vb && vb.width ? vb.width : 1000; this.vbH = vb && vb.height ? vb.height : 700;
    this.positionFocusByProgress(this.sProgress);
  }
}

function setBetAmount(v){ document.getElementById('betAmount').value=v; }
function closeModal(id){ const el=document.getElementById(id); if(el) el.classList.remove('show'); }
let game; window.addEventListener('load', ()=>{ game=new ZeptoCrashGame(); runSelfTests(game); });

/* ======== Self-tests (basic invariants + motion) ======== */
function runSelfTests(g){ try {
  console.assert(g.el.path instanceof SVGPathElement, 'Test: path must be SVGPathElement');
  console.assert(g.pathLen > 0, 'Test: path length > 0');
  console.assert(g.el.focusDot instanceof HTMLElement, 'Test: focus dot exists');
  g.positionFocusByProgress(-1); console.assert(g.pos && g.pos.x >= 0, 'Test: p<0 clamped');
  g.positionFocusByProgress(0.5); console.assert(g.pos && g.pos.x >= 0, 'Test: p=0.5 valid');
  g.positionFocusByProgress(1); console.assert(g.pos && g.pos.x >= 0, 'Test: p>1 clamped');
  const a=easeOutCubic(0.25), b=easeOutCubic(0.5), c=easeOutCubic(0.75); console.assert(a<b && b<c, 'Test: easing monotonic');
  // visual progress must be independent of crashPoint
  g.crashPoint=100; const p1=g.getVisualProgressForMultiplier(2);
  g.crashPoint=2; const p2=g.getVisualProgressForMultiplier(2);
  console.assert(Math.abs(p1-p2) < 1e-9, 'Test: visual progress independent of crashPoint');
  console.log('%cSelf-tests passed','color:#0f0');
} catch(e){ console.error('Self-tests failed', e); }
}
</script>
</body>
</html>